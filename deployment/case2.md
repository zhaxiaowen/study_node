# oa 服务容器化

## 问题现象 :

* 权限服务凌晨容器化时 , 由于是后台管理类服务 , 所以未验证 , 直接切流了 , 导致生产故障 , 后回滚恢复 (领导在用 , 发现用不了了 , 为了不影响使用 , 回滚了)
* 云办公 app 无法使用

## 问题定位 :

* 回滚后业务恢复 , 排查问题
* 回滚后 , 发现还有告警一直未恢复 , 排查
* ingress 健康检查告警 ,oapermissionclient 服务 503(ingress 在腾讯云 , 后端在华为云 , 该服务是权限认证服务)
* 排查发现后端服务正常 , 但是在腾讯云 telnet 不通 , 发现 entbus-gateway 服务出现故障 (nginx 服务 , 负责转发请求)
* 登录 entbus-gateway 的 pod,nginx -t 失败 , 而且该 pod 一个 nginx 端口都未监听 , 找到问题原因 , 今晚要上线的一个服务 , 未绑定 service, 而 nginx 配置的 upstream 是通过服务名 .svc.cluster.local 去转发请求的 , 该服务未创建 service, 导致 nginx 加载失败

## 问题原因 :

* 把服务绑定 svc 控制器 , 重新发布 , 再重发 entbus-gateway 服务后恢复

## 问题解决

* 回滚

## 改进措施 :

1. 准备工作未到位 , 没检查到服务没绑定 svc 控制器
2. 未切流前 , 先发布了 entbus-gateway 服务 , 发布后 , 其实有 ingress 告警 , 但是忙着变更 , 没关注 , 如果此时就停止变更 , 不会发生线上故障
3. 正常情况 , 发布 entbus-gateway 服务时 , 如果配置有问题 , 新的 pod 应该会无法 ready, 旧的 pod 会一直存在 , 但是变更时 , 有去检查这里 , 发现 entbus-gateway 服务新的 pod 是 ready 了的
4. 直接切流原因一个是因为后台管理类服务 , 觉得即时有问题 , 也不会影响到网约车服务 (从意识上没太重视), 而且到凌晨了 , 觉得应该没人用了 , 就跳过了验证这个步骤

* 额外的问题 :
  * 因为凌晨还有几个服务要发版 , 在容器化失败后 , 就把服务发了
  * 我们有个 jenkins 有个选项是为了容器化使用的 , 就是使用线上稳定版本发布 , 而因为我容器化 , 脚本里这个参数就选的 Yes, 没意识到这个 , 导致要发版的服务 , 就用了线上稳定版本重发了 , 相当于没发最新版本
