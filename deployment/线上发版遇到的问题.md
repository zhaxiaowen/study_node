# 发版

### 前端代码发布未获得预期效果

#### 1. 问题现象 :

* 安排晚上上线 , 研发最后再 uat1 环境测试 , 反馈 uat1 环境前端代码发布后 , 页面没有预期改变 , 怀疑 jenkins 有问题

#### 2. 定位过程

1. 查看 jenkins 日志 , 发现一切正常
2. 登录 ansible 服务器 , 查看拉下来的代码包 ,git 分支 , 以及版本号等 , 确认无误 , 反馈给研发 , 然后建议研发新增一个 test 文件 , 我重新发包
3. 新增 test 文件后 , 重新发包 ,test 文件已发布 , 确认发布无误 , 研发坚持还是发包有问题
4. 找研发要了他新增的详细代码 , 去到 ansible 服务器上查到对应的代码 , 反馈给研发
5. 研发去 dev 环境验证 , 并说明 dev1 和 uat1 代码一样 , 但效果不一样 , 明确他那边没问题
6. 我让研发修改其他正常页面 , 如果有改变 , 说明他代码问题 , 如果没改变 , 说明不是代码问题
7. 修改正常页面后 , 还是没效果 , 我才认真考虑起这个问题
8. 查看 cmdb 前端配置 , 发现 nginx 配置都没点生成 , 一下明确 , 大概是运维侧的问题
9. 点击生成 nginx 配置后 , 再检查 nginx 配置 , 发现一切正常 , 再次发包 , 发现还是未生效
10. ping 请求域名 , 发现域名的 nginx 地址与 cmdb 上生成的 nginx 地址不同
11. 将 cmdb 上该服务的前端地址绑定到与域名一致的服务器
12. 再次发包 , 前端界面显示预期结果

#### 3. 问题原因

* 周一做了 fat4 和 uat1 环境的 nginx 迁移 , 将公司内部服务的域名全部部署到一台 app 服务器上 , 对外的域名 , 全部部署在一台 nginx 服务器上 , 配置文件都做了迁移 , 但是对应服务绑定的服务器没有修改
* 原 nginx 服务器上的前端代码都没有删除 , 所以正常的访问是可以 , 但是发布代码没效果

#### 4. 导致后果

* 导致预计晚上发布的版本 , 没能发布 , 推迟一天

#### 5. 思考

1. 本次问题定位 , 从一开始就被研发带偏 , 忽略了实际问题 , 耗费过多时间与研发争论 jenkins 发布是否正常
2. 到后面 , 其实已经觉得研发有点无理取闹 , 一直坚持定位问题的原因 , 是我自己想说服对方是他的错误
3. 反思一下 , 从个人性格来说 , 过程中有点急躁 , 后来就没有真心实意的去想着帮对方解决问题
4. 反思二下 , 忽略了对方的实际诉求是代码没生效 , 但是却把主焦点放在了 jenkins 上

### 前端请求问题

#### 1. 问题现象 :

* 背景 : 前端要求配置多个二级目录 , 已访问不同前端项目 ; 前端目录为 : 一个 main 目录为 / 目录 , 其他项目放在与 main 同级的 sub 目录下 , 各自一个子目录
* nginx 配置完成后 , 请求对应 url, 页面显示空白 , 查看 nginx 日志访问正常 ,F12, 发现 js 请求一片红 ,js 路径配置错误
* 前端修改代码后 , 继续请求 , 请求成功 , 但是刷新页面后 , 页面报 404
* 查看 nginx 日志 , 报 alias 没权限 rewrite...

#### 2. 问题原因

* rewrite 语法的 url 后 , 写的是 break, 改成 last 后 , 可以正常请求

### 灰度发布

#### 问题现象

灰度发布时 , 测试反馈灰度司机接不到单

#### 问题原因

个人问题导致 . 发布时准备了 2 个文档 , 一个是常用命令文档 , 一个是发版流程文档 ; 第二个文档脱胎于第一个文档 , 都有灰度刷用户的命令 ; 发布完成后 , 由于太忙 , 测试再次让加灰度用户时 , 错把新加的灰度用户放到旧的文档里了 ; 导致本次的灰度用户 , 只有最新的添加进去了 , 其他的都被刷掉了 ; 反复 2-3 次

有司机和 taxi 两种用户 ; 不清楚第二种 , 导致测试提供的 taxi 手机号 , 查的是 driver 库的信息 ,uid 不一致 , 添加无效的灰度用户

#### 改进方法

1. 细心一些
2. 流程有些不合理 ; 总是会出现临时新加灰度用户的情况 ; 针对这种情况 , 最好与测试沟通好 , 提前准备好 , 不要出现临时修改的情况
3. 添加灰度用户是手动通过查数据库获取的 , 再手动添加 , 如果可以通过平台化或者自动化 , 提高自动化 , 减少人为操作 , 或许可以降低一些不必要的失误

### 凌晨发版 1

#### 问题现象

1. oa 服务 jenkins 发包失败，原因是 ansible 上传包解压命令失败
2. fileexportimpl 连接数据库异常
3. 测试反馈 oa 前端代码未生效
4. 测试验证时反馈程序异常，日志显示 RPC 请求失败
5. nginx 任务下成功，但配置未下发成功

#### 问题原因

1. nginx 配置未下发成功：/etc/ansible/hosts 文件里没有配 nginx 服务器的 ip, 导致未成功下发，报 `No hosts matched, nothing to do`

2. fileexportimpl 连接数据库异常：连接 oa 库异常，oa 已从腾讯云迁移到华为云，apollo 的 oa 库地址未及时修改，修改后正常

3. oa 问题：

   * 目标服务器 python 问题，导致下发 ansible 命令失败

   * 手动上传包到服务器上部署，坑来了，因为 oa 前几天迁移到华为云了，但是并未用 jenkins 部署，所以 jenkins 上显示上次部署成功的 ip 还是腾讯云的，结果手动部署到旧的服务器上了，结果就是测试反馈代码好像未生效，后来发现后重新部署到华为云服务器，并停掉腾讯云上的服务
   * 程序异常原因：旧的腾讯云的应用未停，部分应用连接的还是腾讯云的应用，结果报程序异常，重启服务后正常

总结

* oa 旧的应用未停，从腾讯云迁移到华为云已经接近 1 周，还有服务连的腾讯云的服务，这个未能及时发现
* 部署 oa 应用未用 jenkins，导致发版时才发现 jenkins 部署失败
* 不够细心，没有从 jenkins 日志去拿应用 ip，而是从上次发布成功的那里拿的 ip，导致部署到腾讯云，无效操作
* 程序异常时，排查不够细心，没有留意到是连接腾讯云的 ip，浪费了比较多时间 ，而且排查方向一直错误，以为是 nginx 配置问题

### 凌晨发版 2

> 凌晨发版后 , 顺便把之前 clb 切换的旧的 clb 释放了

#### 问题 :

早上问题接口超时

#### 问题定位 :

登录对应 nginx 服务器 , 发现 error 日志请求的 upstream 是旧的 clb 地址

#### 问题原因 :

1. 上周做过 clb 切换 , 凌晨时把旧的 clb 释放了
2. clb 已切换一周 , 还有少量流量 , 运维人员未仔细核实流量的出处
3. 业务请求有几个接口 , 报超时的是 h5 页面
4. nginx 的域名解析直接依赖宿主机的 /etc/resolv.conf 配置的 DNS 服务器 ;nginx 无视 TTL 并缓存 DNS 记录 , 直到下一次重启或配置重载

问题处理

* nginx -s reload
